worker_processes 1;

events {
    worker_connections 1024;
}

http {
    server {
        listen 4444;
        server_name _;

        # 1. Redirect /community (no slash) to /community/
        location = /community {
            return 301 $scheme://$host:$server_port/community/;
        }

        # 2. Any request starting with /community/:
        #    - Rewrite the path so Apache sees it as /
        #    - Pass the request to apache-answer on port 80
        location ^~ /community/ {
            # Rewrite /community/foo => /foo, /community/foo/bar => /foo/bar, etc.
            rewrite ^/community/(.*)$ /$1 break;

            proxy_pass http://apache-answer:80;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }

        # 3. Everything else goes to Ghost
        location / {
            proxy_pass http://ghost:2368;
            proxy_set_header Host               $host;
            proxy_set_header X-Real-IP          $remote_addr;
            proxy_set_header X-Forwarded-For    $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto  $scheme;
        }
    }
}
